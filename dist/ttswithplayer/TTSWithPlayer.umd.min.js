!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@isfe/mse-player/src/MSEPlayer"),require("@isfe/mse-player/src/helpers/wavToMp3"),require("@isfe/mse-player/src/helpers/pcmToWav"),require("@isfe/mse-player/src/helpers/base64WithoutPrefixToBlob"),require("@isfe/mse-player/src/helpers/base64ToWavBlob"),require("lamejs"),require("js-base64")):"function"==typeof define&&define.amd?define(["@isfe/mse-player/src/MSEPlayer","@isfe/mse-player/src/helpers/wavToMp3","@isfe/mse-player/src/helpers/pcmToWav","@isfe/mse-player/src/helpers/base64WithoutPrefixToBlob","@isfe/mse-player/src/helpers/base64ToWavBlob","lamejs","js-base64"],e):(t=t||self).TTSWithPlayer=e(t.MSEPlayer,t.wavToMp3,t.pcmToWav,t.base64WithoutPrefixToBlob,t.base64ToWavBlob,t.lamejs,t.jsBase64)}(this,function(i,n,e,s,o,a,y){"use strict";var u,t;i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i,n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n,e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s,o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o,a=a&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a,(t=u=u||{}).idle="idle",t.sessionBegin="ssb",t.textWrite="txtw",t.getResult="grs",t.sessionEnd="sse";var c,r,l=function(){return(l=Object.assign||function(t){for(var e,s=1,r=arguments.length;s<r;s++)for(var i in e=arguments[s])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function h(t,e){return{AISdkError:!0,type:t,error:e}}(r=c=c||{}).RESPONSE_ERROR="RESPONSE_ERROR",r.NO_RESPONSE="NO_RESPONSE",r.NOT_SUPPORTED_TYPE="NOT_SUPPORTED_TYPE",r.GET_TYPE_ERROR="GET_TYPE_ERROR";var d=Promise.resolve(),p=(f.prototype.start=function(s){var r=this;if(this.status===u.idle){this.status=u.sessionBegin;var i={svc:"tts",syncid:"0".toString()},t=l(l({},s.ttsOption),{cmd:this.status,svc:i.svc,syncid:i.syncid});return this.end=this._end.bind(this,s,i),this.interact(t,s,i).then(function(){return r.onSuccessAdaptor()}).catch(function(t){var e=h(c.NO_RESPONSE,t);if(r.onErrorAdaptor(e),r.status!==u.sessionEnd&&r.status!==u.idle)return r._end(s,i);throw e}).finally(function(){return r.onCompleteAdaptor()})}},f.prototype._end=function(t,e){var s=this;if(this.status===u.sessionEnd||this.status===u.idle)return d;if(this.status=u.sessionEnd,!e.sid)return d;var r=t.ttsOption,i=r.appid,n=r.extend_params,o={auth_id:t.ttsOption.auth_id,appid:i,extend_params:n,cmd:this.status,sid:e.sid,syncid:e.syncid,svc:e.svc};return this.interact(o,t,e).catch(function(t){throw s.status=u.idle,t})},f.prototype.onSuccessAdaptor=function(){this.onSuccess&&this.onSuccess()},f.prototype.onCompleteAdaptor=function(){this.onComplete&&this.onComplete()},f.prototype.onErrorAdaptor=function(t){this.onError&&this.onError(t)},f.prototype.processResponse=function(t,e,s){var r=t.result;if(!r){var i=h(c.NO_RESPONSE,t);return this.onErrorAdaptor(i),Promise.reject(i)}if(0!==r.ret)return i=h(c.RESPONSE_ERROR,t),this.onErrorAdaptor(i),Promise.reject(i);var n=e.ttsOption,o={appid:n.appid,extend_params:n.extend_params,sid:s.sid||"",syncid:s.syncid,svc:s.svc};if(this.status===u.sessionBegin){s.sid=r.sid,this.status=u.textWrite;var a=l(l({},o),{cmd:this.status,sid:s.sid,data:y.Base64.encode(e.text)});return this.interact(a,e,s)}if(this.status===u.textWrite)return this.status=u.getResult,a=l(l({},o),{cmd:this.status}),this.interact(a,e,s);if(this.status!==u.getResult)return this.status===u.sessionEnd&&(this.status=u.idle),d;var p=r;return p.data&&this.processPCMBase64Data(p.data),0===p.ttsStatus?this._end(e,s):(a=l(l({},o),{cmd:this.status}),this.interact(a,e,s))},f.prototype.interact=function(t,e,s){var r=this;s.syncid=(+s.syncid+1).toString();var i,n,o,a,p,u,c,l,h,d,f={id:1,jsonrpc:"2.0",method:"deal_request",params:t};return i={url:e.url,method:e.apiMethod,param:JSON.stringify(f)},o=(n=void 0===i?{}:i).url,a=void 0===o?"":o,p=n.method,u=void 0===p?"post":p,c=n.param,l=void 0===c?"":c,h=n.timeout,d=void 0===h?5e3:h,new Promise(function(s,r){u=u.toUpperCase();var i=new XMLHttpRequest;i.open(u,a,!0),i.timeout=d,i.setRequestHeader("Content-Type","application/json-rpc"),i.send(l),i.addEventListener("readystatechange",function(){if(i.readyState===i.DONE){var t=i.status;if(200<=t&&t<300||304===t)try{var e=JSON.parse(y.Base64.atob(i.responseText));s(e)}catch(t){r(t)}else r(i)}})}).then(function(t){return r.processResponse(t,e,s)})},f);function f(t,e,s,r){this.processPCMBase64Data=t,this.onSuccess=e,this.onError=s,this.onComplete=r,this.status=u.idle}function m(t){return Promise.resolve(t)}function v(){}function E(t,e,s,r,i){void 0===e&&(e=v),void 0===s&&(s=v),void 0===r&&(r=v),void 0===i&&(i=v),this.$audio=t,this.onNext=e,this.onSuccess=s,this.onError=r,this.onComplete=i,this.playing=!1,this.internalProcessPCMBase64Data=this.internalProcessPCMBase64Data.bind(this),this.internalOnComplete=this.internalOnComplete.bind(this),this.internalOnError=this.internalOnError.bind(this),this.onSuccess=this.onSuccess.bind(this),this.onNext=this.onNext.bind(this),this.tts=new p(this.internalProcessPCMBase64Data,this.onSuccess,this.internalOnError,this.internalOnComplete)}return E.prototype.internalProcessPCMBase64Data=function(t){var r=this;this.onNext(t),t&&(this.internalDummyPromise||(this.internalDummyPromise=m()),this.mp3Enc||(this.mp3Enc=new a.Mp3Encoder(1,16e3,64)),this.internalDummyPromise=this.internalDummyPromise.then(function(){return Promise.all([t].map(function(t){return e(s(t))})).then(function(t){var e=t.map(function(t){return o(t)}),s=r.mp3Enc;return r.player.appendFiles(e,function(t){return n(s,t,{kbps:64,flush:!1})}).then(function(){return r.$audio.play()})})}))},E.prototype.internalOnComplete=function(){var t=this;if(this.mp3Enc){var e=this.mp3Enc.flush();if(0<e.length&&this.player){var s=new Blob([e]);this.player.appendFiles([s]).then(function(){return t.$audio.play()})}}this.internalDispose()},E.prototype.internalOnError=function(){this.internalDispose()},E.prototype.internalDispose=function(t){void 0===t&&(t=!1),this.mp3Enc=null,this.internalDummyPromise=null,t&&this.disposePlayer()},E.prototype.disposePlayer=function(){if(this.player&&this.$audio.src)try{URL.revokeObjectURL(this.$audio.src)}catch(t){}this.player=null},E.prototype.destroy=function(){this.internalDispose(!0)},E.prototype.start=function(t,e){var s=this;if(void 0===e&&(e=!1),!e&&this.tts.status!==u.idle)return m();var r=m();return e&&this.tts.end&&(r=this.tts.end().catch(v)),r.then(function(){return s.disposePlayer(),s.player=new i,s.$audio.src=URL.createObjectURL(s.player.mediaSource),s.tts.start(t)})},E.prototype.end=function(){var t=this,e=m();return this.tts.end&&(e=this.tts.end()),e.finally(function(){return t.internalDispose()}),e},E.prototype.getEstimatedDuration=function(t){return t.length/5},E.prototype.onAudioDurationChange=function(){return 0},E.prototype.play=function(){},E.prototype.pause=function(){},E.prototype.stop=function(){},E});
//# sourceMappingURL=TTSWithPlayer.umd.min.js.map
