!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lamejs"),require("js-base64")):"function"==typeof define&&define.amd?define(["lamejs","js-base64"],e):(t=t||self).TTSWithPlayer=e(t.lamejs,t.jsBase64)}(this,function(f,v){"use strict";f=f&&f.hasOwnProperty("default")?f.default:f;var c=function(){return(c=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function h(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,s=n.call(t),o=[];try{for(;(void 0===e||0<e--)&&!(r=s.next()).done;)o.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o}function l(r){return new Promise(function(t,e){var n=new FileReader;n.addEventListener("load",function(){return t(n.result)}),n.addEventListener("error",function(t){return e(t)}),n.readAsArrayBuffer(r)})}var d,t,i=(m.checkEnvSupported=function(){return"MediaSource"in window},m.prototype.appendFiles=function(i,e,t){var n,s=this;function o(t){return Promise.resolve(t).then(e).then(function(t){return s.transformer(t)})}void 0===i&&(i=[]),void 0===e&&(e=y),void 0===t&&(t=!0),n=i,i=[].slice.call(n),t&&this.lastAppend$.catch(function(){});var r=this.lastAppend$.then(function(){return t=i,e=s.mediaSource,n=s.sourceBuffer,r=o,function(t){return Promise.all(t.map(function(t){return l(t).then(null,function(t){return Promise.reject(E("READ_FILE_ERROR",t))})}))}(t).then(function(t){return r(t)}).then(function(t){return i=e,s=n,o=t,new Promise(function(t,e){function n(){if(0===o.length)return i.endOfStream(),s.removeEventListener("updateend",n),s.removeEventListener("error",r),void t();s.appendBuffer(o.shift())}function r(t){e(E("APPEND_BUFFER_ERROR",t))}s.addEventListener("updateend",n),s.addEventListener("error",r),n()});var i,s,o});var t,e,n,r});return this.lastAppend$=r.catch(function(t){s.onError(E("APPEND_ERROR",t))}),this.ignoreError?this.lastAppend$:r},m.prototype.destroy=function(){this.mediaSource=null,this.sourceBuffer=null},m);function m(t){var r=this;void 0===t&&(t={});var e=t.files,n=void 0===e?[]:e,i=t.mimeType,s=void 0===i?"audio/mpeg":i,o=t.onError,a=t.ignoreError,u=void 0===a||a,c=t.transformer,d=void 0===c?y:c;if(this.envSupported=m.checkEnvSupported(),this.onError=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t=o,"[object Function]"===Object.prototype.toString.call(t)&&o.call.apply(o,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(h(arguments[e]));return t}([r],e))},this.envSupported)if(MediaSource.isTypeSupported(s)){this.mimeType=s,this.sourceBuffer=null,this.ignoreError=u,this.transformer=d,this.mediaSource=new MediaSource;var p=this;this.lastAppend$=new Promise(function(e){var n=p.mediaSource;n.addEventListener("sourceopen",function t(){n.removeEventListener("sourceopen",t),p.sourceBuffer=n.addSourceBuffer(p.mimeType),e()})}),0<n.length&&this.appendFiles(n)}else this.onError(E("MIME_TYPE_NOT_SUPPORTED"));else this.onError(E("MEDIA_SOURCE_NOT_SUPPORTED"))}function y(t){return t}function E(t,e){return{type:t,error:e}}function s(t){return"data:audio/wav;base64,"+(e=new Uint8Array(t).reduce(function(t,e){return t+String.fromCharCode(e)},""),btoa(e));var e}function o(t,e,n,r){var i=t.byteLength,s=new ArrayBuffer(44+i),o=new DataView(s);function a(t,e,n){for(var r=0;r<n.length;r++)t.setUint8(e+r,n.charCodeAt(r))}var u=0;return a(o,u,"RIFF"),u+=4,o.setUint32(u,36+i,!0),a(o,u+=4,"WAVE"),a(o,u+=4,"fmt "),u+=4,o.setUint32(u,16,!0),u+=4,o.setUint16(u,1,!0),u+=2,o.setUint16(u,r,!0),u+=2,o.setUint32(u,e,!0),u+=4,o.setUint32(u,e*r*(n/8),!0),u+=4,o.setUint16(u,r*(n/8),!0),u+=2,o.setUint16(u,n,!0),a(o,u+=2,"data"),u+=4,o.setUint32(u,i,!0),u+=4,16===n?function(t,e,n){for(var r=new Int16Array(n),i=0;i<r.length;i++,e+=2)t.setInt16(e,r[i],!0)}(o,44,t):8===n?function(t,e,n){for(var r=new Int8Array(n),i=0;i<r.length;i++,e++)t.setInt8(e,r[i])}(o,44,t):function(t,e,n){for(var r=new Int32Array(n),i=0;i<r.length;i++,e+=4)t.setInt32(e,r[i],!0)}(o,44,t),o.buffer}function a(t,e){for(var n=atob(t),r=n.length,i=new Uint8Array(r);r--;)i[r]=n.charCodeAt(r);return new Blob([i],e)}function r(t){return e={type:"wav"},a(t.split(",")[1],e);var e}(t=d=d||{}).idle="idle",t.sessionBegin="ssb",t.textWrite="txtw",t.getResult="grs",t.sessionEnd="sse";var p,e;function S(t,e){return{AISdkError:!0,type:t,error:e}}(e=p=p||{}).RESPONSE_ERROR="RESPONSE_ERROR",e.NO_RESPONSE="NO_RESPONSE";var P=Promise.resolve(),u=(n.prototype.start=function(n){var r=this;if(this.status===d.idle){this.status=d.sessionBegin;var i={svc:"tts",syncid:"0".toString()},t=c(c({},n.ttsOption),{cmd:this.status,svc:i.svc,syncid:i.syncid});return this.end=this._end.bind(this,n,i),this.interact(t,n,i).then(function(){return r.onSuccessAdaptor()}).catch(function(t){var e=S(p.NO_RESPONSE,t);if(r.onErrorAdaptor(e),r.status!==d.sessionEnd&&r.status!==d.idle)return r._end(n,i);throw e}).finally(function(){return r.onCompleteAdaptor()})}},n.prototype._end=function(t,e){var n=this;if(this.status===d.sessionEnd||this.status===d.idle)return P;if(this.status=d.sessionEnd,!e.sid)return P;var r=t.ttsOption,i=r.appid,s=r.extend_params,o={auth_id:t.ttsOption.auth_id,appid:i,extend_params:s,cmd:this.status,sid:e.sid,syncid:e.syncid,svc:e.svc};return this.interact(o,t,e).catch(function(t){throw n.status=d.idle,t})},n.prototype.onSuccessAdaptor=function(){this.onSuccess&&this.onSuccess()},n.prototype.onCompleteAdaptor=function(){this.onComplete&&this.onComplete()},n.prototype.onErrorAdaptor=function(t){this.onError&&this.onError(t)},n.prototype.processResponse=function(t,e,n){var r=t.result;if(!r){var i=S(p.NO_RESPONSE,t);return this.onErrorAdaptor(i),Promise.reject(i)}if(0!==r.ret)return i=S(p.RESPONSE_ERROR,t),this.onErrorAdaptor(i),Promise.reject(i);var s=e.ttsOption,o={appid:s.appid,extend_params:s.extend_params,sid:n.sid||"",syncid:n.syncid,svc:n.svc};if(this.status===d.sessionBegin){n.sid=r.sid,this.status=d.textWrite;var a=c(c({},o),{cmd:this.status,sid:n.sid,data:v.Base64.encode(e.text)});return this.interact(a,e,n)}if(this.status===d.textWrite)return this.status=d.getResult,a=c(c({},o),{cmd:this.status}),this.interact(a,e,n);if(this.status!==d.getResult)return this.status===d.sessionEnd&&(this.status=d.idle),P;var u=r;return u.data&&this.processPCMBase64Data(u.data),0===u.ttsStatus?this._end(e,n):(a=c(c({},o),{cmd:this.status}),this.interact(a,e,n))},n.prototype.interact=function(t,e,n){var r=this;n.syncid=(+n.syncid+1).toString();var i,s,o,a,u,c,d,p,h,f,l={id:1,jsonrpc:"2.0",method:"deal_request",params:t};return(i={url:e.url,method:e.apiMethod,param:JSON.stringify(l)},o=(s=void 0===i?{}:i).url,a=void 0===o?"":o,u=s.method,c=void 0===u?"post":u,d=s.param,p=void 0===d?"":d,h=s.timeout,f=void 0===h?5e3:h,new Promise(function(n,r){c=c.toUpperCase();var i=new XMLHttpRequest;i.open(c,a,!0),i.timeout=f,i.setRequestHeader("Content-Type","application/json-rpc"),i.send(p),i.addEventListener("readystatechange",function(){if(i.readyState===i.DONE){var t=i.status;if(200<=t&&t<300||304===t)try{var e=JSON.parse(v.Base64.atob(i.responseText));n(e)}catch(t){r(t)}else r(i)}})})).then(function(t){return r.processResponse(t,e,n)})},n);function n(t,e,n,r){this.processPCMBase64Data=t,this.onSuccess=e,this.onError=n,this.onComplete=r,this.status=d.idle}function O(t){return Promise.resolve(t)}function R(){}function g(t,e,n,r,i){void 0===e&&(e=R),void 0===n&&(n=R),void 0===r&&(r=R),void 0===i&&(i=R),this.$audio=t,this.onNext=e,this.onSuccess=n,this.onError=r,this.onComplete=i,this.playing=!1,this.internalProcessPCMBase64Data=this.internalProcessPCMBase64Data.bind(this),this.internalOnComplete=this.internalOnComplete.bind(this),this.internalOnError=this.internalOnError.bind(this),this.onSuccess=this.onSuccess.bind(this),this.onNext=this.onNext.bind(this),this.tts=new u(this.internalProcessPCMBase64Data,this.onSuccess,this.internalOnError,this.internalOnComplete)}return g.prototype.internalProcessPCMBase64Data=function(t){var n=this;this.onNext(t),t&&(this.internalDummyPromise||(this.internalDummyPromise=O()),this.mp3Enc||(this.mp3Enc=new f.Mp3Encoder(1,16e3,64)),this.internalDummyPromise=this.internalDummyPromise.then(function(){return Promise.all([t].map(function(t){return e=a(t),void 0===n&&(n=16e3),void 0===r&&(r=16),void 0===i&&(i=1),l(e).then(function(t){return s(o(t,n,r,i))});var e,n,r,i})).then(function(t){var e=t.map(function(t){return r(t)}),o=n.mp3Enc;return n.player.appendFiles(e,function(t){return c=o,e=t,r=(n={kbps:64,flush:!1}).kbps,d=void 0===r?128:r,i=n.flush,p=void 0===i||i,s=n.optimize,h=void 0!==s&&s,Promise.all(e.map(function(t){var e=f.WavHeader.readHeader(new DataView(t)),n=new Int16Array(t,e.dataOffset,e.dataLen/2),r=[];if(c=c||new f.Mp3Encoder(e.channels,e.sampleRate,d),h)for(var i=n.length,s=0;1152<=i;s+=1152){var o=n.subarray(s,s+1152);0<(a=c.encodeBuffer(o)).length&&r.push(new Int8Array(a)),i-=1152}else{var a=c.encodeBuffer(n);r.push(new Int8Array(a))}if(p){var u=c.flush();0<u.length&&r.push(new Int8Array(u))}return l(new Blob(r,{type:"audio/mpeg"}))}));var c,e,n,r,d,i,p,s,h}).then(function(){return n.$audio.play()})})}))},g.prototype.internalOnComplete=function(){var t=this;if(this.mp3Enc){var e=this.mp3Enc.flush();if(0<e.length&&this.player){var n=new Blob([e]);this.player.appendFiles([n]).then(function(){return t.$audio.play()})}}this.internalDispose()},g.prototype.internalOnError=function(){this.internalDispose()},g.prototype.internalDispose=function(t){void 0===t&&(t=!1),this.mp3Enc=null,this.internalDummyPromise=null,t&&this.disposePlayer()},g.prototype.disposePlayer=function(){if(this.player&&this.$audio.src)try{URL.revokeObjectURL(this.$audio.src)}catch(t){}this.player=null},g.prototype.destroy=function(){this.internalDispose(!0)},g.prototype.start=function(t,e){var n=this;if(void 0===e&&(e=!1),!e&&this.tts.status!==d.idle)return O();var r=O();return e&&this.tts.end&&(r=this.tts.end().catch(R)),r.then(function(){return n.disposePlayer(),n.player=new i,n.$audio.src=URL.createObjectURL(n.player.mediaSource),n.tts.start(t)})},g.prototype.end=function(){var t=this,e=O();return this.tts.end&&(e=this.tts.end()),e.finally(function(){return t.internalDispose()}),e},g.prototype.getEstimatedDuration=function(t){return t.length/5},g.prototype.onAudioDurationChange=function(){return 0},g.prototype.play=function(){},g.prototype.pause=function(){},g.prototype.stop=function(){},g});
//# sourceMappingURL=TTSWithPlayer.umd.min.js.map
