{"version":3,"file":"TTS.umd.min.js","sources":["../../src/tts/index.ts","../../src/shares/apis/httpNet.ts"],"sourcesContent":["import httpNet from '../shares/apis/httpNet'\r\nimport { Base64 }  from 'js-base64'\r\n\r\nconst ttsStatus = {\r\n  'idle': 'idle', //空闲\r\n  'sessionBegin': 'ssb', //session begin 会话开始\r\n  'textWrite': 'txtw', //text put 写入文本\r\n  'getResult': 'grs', //get result 获取结果\r\n  'sessionEnd': 'sse' //session end 会话结束\r\n}\r\n\r\n// 公共参数\r\nconst commonParam = {\r\n  id: 1,\r\n  jsonrpc: '2.0',\r\n  method: 'deal_request',\r\n  params: {\r\n    svc: 'tts',\r\n  }\r\n}\r\n\r\nfunction cloneDeep (data) {\r\n  return JSON.parse(JSON.stringify(data))\r\n}\r\n\r\nfunction id<T> (x: T) {\r\n  return x\r\n}\r\n\r\nexport default class Tts {\r\n  text: string\r\n  url: string\r\n  serverParams: Object\r\n  extendParams: Object\r\n  status: string\r\n  sessionId: string\r\n  syncid: number\r\n  appid: string\r\n  detailData: Function\r\n  constructor () {\r\n    this.syncid = 0\r\n    this.status = null\r\n    this.extendParams = null\r\n    this.text = null\r\n    this.serverParams = null\r\n    this.sessionId = null\r\n  }\r\n\r\n  // 初始化tts, 进行sessionBegin操作\r\n  initTts (url: string = '', params: any, text: string = '') {\r\n    this.text = text\r\n    this.serverParams = params\r\n    this.extendParams = params.extend_params\r\n    this.url = url\r\n    this.start()\r\n  }\r\n  \r\n  start () {\r\n    this.syncid = 0\r\n    this.status = ttsStatus.sessionBegin\r\n    let data = cloneDeep(commonParam)\r\n    data.params = Object.assign({ }, data.params, this.serverParams)\r\n    data.params.cmd = this.status\r\n    data.params.syncid = this.syncid.toString()\r\n    this.syncid ++\r\n    this.getData(data)\r\n  }\r\n\r\n  // 获取tts各个阶段请求的参数\r\n  transApiData (data: any = { }) {\r\n    const msg = cloneDeep(commonParam)\r\n    data.sid = this.sessionId\r\n    data.appid = this.appid\r\n    data.cmd = this.status\r\n    data.syncid = this.syncid.toString()\r\n    data.extend_params = this.extendParams\r\n    msg.params = Object.assign({ }, msg.params, data)\r\n    return msg\r\n  }\r\n\r\n  detailData (callback: Function = id) {\r\n    this.detailData = callback\r\n  }\r\n\r\n\r\n  end () {\r\n    if (!this.status || this.status === ttsStatus.sessionEnd || this.status === ttsStatus.idle) {\r\n      return\r\n    }\r\n    const data = { auth_id: this.serverParams.auth_id }\r\n    this.status = ttsStatus.sessionEnd\r\n    const sseData = this.transApiData(data)\r\n    this.getData(sseData)\r\n  }\r\n\r\n  onError (error: string = '') {\r\n    console.log(error)\r\n  }\r\n\r\n  processResponse (data) {\r\n    if (!data) {\r\n      this.onError()\r\n      return\r\n    }\r\n    this.syncid ++\r\n    console.log('x', (Base64))\r\n    const transData = JSON.parse(Base64.atob(data))\r\n    if (!transData.result || transData.result.ret !== 0) {\r\n      this.onError('数据有误')\r\n      return\r\n    }\r\n    if (this.status === ttsStatus.sessionBegin) {\r\n      this.sessionId = transData.result.sid\r\n      this.status = ttsStatus.textWrite\r\n      const data = { data: Base64.encode(this.text) }\r\n      const txtwData = this.transApiData(data)\r\n      this.getData(txtwData)\r\n      return\r\n    }\r\n    if (this.status === ttsStatus.textWrite) {\r\n      this.status = ttsStatus.getResult\r\n      const grsData = this.transApiData()\r\n      this.getData(grsData)\r\n      return\r\n    }\r\n    if (this.status === ttsStatus.getResult) {\r\n      if (transData.result.data) {\r\n        this.detailData(transData.result.data)\r\n      }\r\n      if (transData.result.ttsStatus !== 0) {\r\n        const grsData = this.transApiData()\r\n        this.getData(grsData)\r\n      } else {\r\n        this.end()\r\n      }\r\n      return\r\n    }\r\n    if (this.status === ttsStatus.sessionEnd) {\r\n      this.status = ttsStatus.idle\r\n    }\r\n  }\r\n\r\n  getData (data: Object = { }, method: string = 'post') {\r\n    httpNet(method, this.url, JSON.stringify(data), (err, data) => {\r\n      if (!err) {\r\n        this.processResponse(data)\r\n      } else {\r\n        this.onError(err)\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\n","export default function api (method: string = 'POST', url: string, param: string, callback: Function) {\n  method = method.toUpperCase()\n  const xmlHttp = new XMLHttpRequest()\n  xmlHttp.open(method, url, true)\n  xmlHttp.timeout = 5 * 1000\n  xmlHttp.setRequestHeader('Content-Type', 'application/json-rpc')\n  xmlHttp.send(param)\n  xmlHttp.onreadystatechange = function () {\n    let ret = null\n    try {\n      ret = xmlHttp.responseText\n    } catch (e) { }\n    if (xmlHttp.readyState === 4) {\n      if (xmlHttp.status >= 200 && xmlHttp.status < 300) {\n        callback(null, ret)\n      } else {\n        if (xmlHttp.status === 500) {\n          callback(new Error('系统异常'), ret)\n          return\n        }\n        if (xmlHttp.status === 504) {\n          callback(new Error('网络超时'), ret)\n          return\n        }\n        callback(new Error('请求失败'), ret)\n      }\n    }\n  }\n}\n"],"names":["ttsStatus","commonParam","id","jsonrpc","method","params","svc","cloneDeep","data","JSON","parse","stringify","x","this","syncid","status","extendParams","text","serverParams","sessionId","Tts","url","extend_params","start","Object","assign","cmd","toString","getData","msg","sid","appid","callback","detailData","auth_id","sseData","transApiData","error","console","log","Base64","transData","atob","result","ret","grsData","end","data_1","encode","txtwData","onError","param","toUpperCase","xmlHttp","XMLHttpRequest","open","timeout","setRequestHeader","send","onreadystatechange","responseText","e","readyState","Error","httpNet","err","_this","processResponse"],"mappings":"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"}