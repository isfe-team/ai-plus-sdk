!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).TTSPlayer=e()}(this,function(){"use strict";function __read(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,a=r.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(n=a.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return s}function __spread(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t}var MSEPlayer=(m.checkEnvSupported=function(){return"MediaSource"in window},m.prototype.appendFiles=function(t,e,r){var n=this;function o(t){return Promise.resolve(t).then(e).then(function(t){return n.transformer(t)})}void 0===t&&(t=[]),void 0===e&&(e=identity),void 0===r&&(r=!0),t=toArray(t),r&&this.lastAppend$.catch(function(){});var a=this.lastAppend$.then(function(){return combine(t,n.mediaSource,n.sourceBuffer,o)});return this.lastAppend$=a.catch(function(t){n.onError(genError("APPEND_ERROR",t))}),this.ignoreError?this.lastAppend$:a},m.prototype.destroy=function(){this.mediaSource=null,this.sourceBuffer=null},m);function m(t){var r=this;void 0===t&&(t={});var e=t.files,n=void 0===e?[]:e,o=t.mimeType,a=void 0===o?"audio/mpeg":o,s=t.onError,i=t.ignoreError,u=void 0===i||i,c=t.transformer,d=void 0===c?identity:c;if(this.envSupported=m.checkEnvSupported(),this.onError=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];isFunction(s)&&s.call.apply(s,__spread([r],t))},this.envSupported)if(MediaSource.isTypeSupported(a)){this.mimeType=a,this.sourceBuffer=null,this.ignoreError=u,this.transformer=d,this.mediaSource=new MediaSource;var f=this;this.lastAppend$=new Promise(function(e){var r=f.mediaSource;r.addEventListener("sourceopen",function t(){r.removeEventListener("sourceopen",t),f.sourceBuffer=r.addSourceBuffer(f.mimeType),e()})}),0<n.length&&this.appendFiles(n)}else this.onError(genError("MIME_TYPE_NOT_SUPPORTED"));else this.onError(genError("MEDIA_SOURCE_NOT_SUPPORTED"))}function read(t){return Promise.all(t.map(function(n){return new Promise(function(t,e){var r=new FileReader;r.addEventListener("load",function(){t(r.result)}),r.readAsArrayBuffer(n),r.addEventListener("error",function(t){e(genError("READ_FILE_ERROR",t))})})}))}function buffer(o,a,s){return new Promise(function(t,e){function r(){if(0===s.length)return o.endOfStream(),a.removeEventListener("updateend",r),a.removeEventListener("error",n),void t();a.appendBuffer(s.shift())}function n(t){e(genError("APPEND_BUFFER_ERROR",t))}a.addEventListener("updateend",r),a.addEventListener("error",n),r()})}function combine(t,e,r,n){return read(t).then(function(t){return n(t)}).then(function(t){return buffer(e,r,t)})}function identity(t){return t}function isFunction(t){return"[object Function]"===Object.prototype.toString.call(t)}function toArray(t){return[].slice.call(t)}function genError(t,e){return{type:t,error:e}}function pcmToWav(t,n,o,a){void 0===n&&(n=16e3),void 0===o&&(o=16),void 0===a&&(a=1);var s=new FileReader,e=new Promise(function(e,r){s.addEventListener("load",function(){var t=addWavHeader(s.result,n,o,a);e(bufferToBase64(t))}),s.addEventListener("error",function(t){r(t)})});return s.readAsArrayBuffer(t),e}function addWavHeader(t,e,r,n){var o=t.byteLength,a=new ArrayBuffer(44+o),s=new DataView(a);function i(t,e,r){for(var n=0;n<r.length;n++)t.setUint8(e+n,r.charCodeAt(n))}var u=0;return i(s,u,"RIFF"),u+=4,s.setUint32(u,36+o,!0),i(s,u+=4,"WAVE"),i(s,u+=4,"fmt "),u+=4,s.setUint32(u,16,!0),u+=4,s.setUint16(u,1,!0),u+=2,s.setUint16(u,n,!0),u+=2,s.setUint32(u,e,!0),u+=4,s.setUint32(u,e*n*(r/8),!0),u+=4,s.setUint16(u,n*(r/8),!0),u+=2,s.setUint16(u,r,!0),i(s,u+=2,"data"),u+=4,s.setUint32(u,o,!0),u+=4,16===r?function(t,e,r){for(var n=new Int16Array(r),o=0;o<n.length;o++,e+=2)t.setInt16(e,n[o],!0)}(s,44,t):8===r?function(t,e,r){for(var n=new Int8Array(r),o=0;o<n.length;o++,e++)t.setInt8(e,n[o])}(s,44,t):function(t,e,r){for(var n=new Int32Array(r),o=0;o<n.length;o++,e+=4)t.setInt32(e,n[o],!0)}(s,44,t),s.buffer}function bufferToBase64(t){var e=new Uint8Array(t).reduce(function(t,e){return t+String.fromCharCode(e)},"");return"data:audio/wav;base64,"+btoa(e)}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(t,e){return t(e={exports:{}},e.exports),e.exports}var base64=createCommonjsModule(function(module,exports){var eb,fb;eb="undefined"!=typeof self?self:"undefined"!=typeof window?window:commonjsGlobal,fb=function(global){global=global||{};var _Base64=global.Base64,version="2.5.1",buffer;if(module.exports)try{buffer=eval("require('buffer').Buffer")}catch(t){buffer=void 0}var b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64tab=function(t){for(var e={},r=0,n=t.length;r<n;r++)e[t.charAt(r)]=r;return e}(b64chars),fromCharCode=String.fromCharCode,cb_utob=function(t){if(t.length<2)return(e=t.charCodeAt(0))<128?t:e<2048?fromCharCode(192|e>>>6)+fromCharCode(128|63&e):fromCharCode(224|e>>>12&15)+fromCharCode(128|e>>>6&63)+fromCharCode(128|63&e);var e=65536+1024*(t.charCodeAt(0)-55296)+(t.charCodeAt(1)-56320);return fromCharCode(240|e>>>18&7)+fromCharCode(128|e>>>12&63)+fromCharCode(128|e>>>6&63)+fromCharCode(128|63&e)},re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,utob=function(t){return t.replace(re_utob,cb_utob)},cb_encode=function(t){var e=[0,2,1][t.length%3],r=t.charCodeAt(0)<<16|(1<t.length?t.charCodeAt(1):0)<<8|(2<t.length?t.charCodeAt(2):0);return[b64chars.charAt(r>>>18),b64chars.charAt(r>>>12&63),2<=e?"=":b64chars.charAt(r>>>6&63),1<=e?"=":b64chars.charAt(63&r)].join("")},btoa=global.btoa?function(t){return global.btoa(t)}:function(t){return t.replace(/[\s\S]{1,3}/g,cb_encode)},_encode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(t){return(t.constructor===buffer.constructor?t:buffer.from(t)).toString("base64")}:function(t){return(t.constructor===buffer.constructor?t:new buffer(t)).toString("base64")}:function(t){return btoa(utob(t))},encode=function(t,e){return e?_encode(String(t)).replace(/[+\/]/g,function(t){return"+"==t?"-":"_"}).replace(/=/g,""):_encode(String(t))},encodeURI=function(t){return encode(t,!0)},re_btou=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g"),cb_btou=function(t){switch(t.length){case 4:var e=((7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3))-65536;return fromCharCode(55296+(e>>>10))+fromCharCode(56320+(1023&e));case 3:return fromCharCode((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return fromCharCode((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},btou=function(t){return t.replace(re_btou,cb_btou)},cb_decode=function(t){var e=t.length,r=e%4,n=(0<e?b64tab[t.charAt(0)]<<18:0)|(1<e?b64tab[t.charAt(1)]<<12:0)|(2<e?b64tab[t.charAt(2)]<<6:0)|(3<e?b64tab[t.charAt(3)]:0),o=[fromCharCode(n>>>16),fromCharCode(n>>>8&255),fromCharCode(255&n)];return o.length-=[0,0,2,1][r],o.join("")},_atob=global.atob?function(t){return global.atob(t)}:function(t){return t.replace(/\S{1,4}/g,cb_decode)},atob=function(t){return _atob(String(t).replace(/[^A-Za-z0-9\+\/]/g,""))},_decode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(t){return(t.constructor===buffer.constructor?t:buffer.from(t,"base64")).toString()}:function(t){return(t.constructor===buffer.constructor?t:new buffer(t,"base64")).toString()}:function(t){return btou(_atob(t))},decode=function(t){return _decode(String(t).replace(/[-_]/g,function(t){return"-"==t?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))},noConflict=function(){var t=global.Base64;return global.Base64=_Base64,t};if(global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict,__buffer__:buffer},"function"==typeof Object.defineProperty){var noEnum=function(t){return{value:t,enumerable:!1,writable:!0,configurable:!0}};global.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",noEnum(function(){return decode(this)})),Object.defineProperty(String.prototype,"toBase64",noEnum(function(t){return encode(this,t)})),Object.defineProperty(String.prototype,"toBase64URI",noEnum(function(){return encode(this,!0)}))}}return global.Meteor&&(Base64=global.Base64),module.exports&&(module.exports.Base64=global.Base64),{Base64:global.Base64}},module.exports=fb(eb)}),base64_1=base64.Base64,TTSStatus,bc;function http(t,o,a){return void 0===o&&(o="POST"),new Promise(function(e,r){o=o.toUpperCase();var n=new XMLHttpRequest;n.open(o,t,!0),n.timeout=5e3,n.setRequestHeader("Content-Type","application/json-rpc"),n.send(a),n.onreadystatechange=function(){if(4===n.readyState){if(200<=n.status&&n.status<300){var t=null;try{t=JSON.parse(base64_1.atob(n.responseText))}catch(t){return void r(t)}return void e(t)}if(500===n.status)return void r(new Error("系统异常"));if(504===n.status)return void r(new Error("网络超时"));r(new Error("请求失败"))}}})}function genRPCMessage(t){return{id:1,jsonrpc:"2.0",method:"deal_request",params:t}}bc=TTSStatus=TTSStatus||{},bc.idle="idle",bc.sessionBegin="ssb",bc.textWrite="txtw",bc.getResult="grs",bc.sessionEnd="sse";var TTS=(dc.prototype.start=function(t){if(this.status===TTSStatus.idle){this.status=TTSStatus.sessionBegin;var e=t.ttsOption;e.cmd=this.status;var r={svc:"tts",syncid:(-1).toString()};e.svc=r.svc,this.getData(e,t,r)}},dc.prototype.end=function(t,e){var r=this;if(this.status!==TTSStatus.sessionEnd&&this.status!==TTSStatus.idle){this.status=TTSStatus.sessionEnd;var n=t.ttsOption,o=n.appid,a=n.extend_params,s={auth_id:t.ttsOption.auth_id,appid:o,extend_params:a,cmd:this.status,sid:e.sid,syncid:e.syncid,svc:e.svc};this.getData(s,t,e).catch(function(){r.status,TTSStatus.idle})}},dc.prototype.onError=function(t){void 0===t&&(t=""),console.log(t)},dc.prototype.processResponse=function(t,e,r){if(t)if(0===t.ret)if(this.status!==TTSStatus.sessionBegin)if(this.status!==TTSStatus.textWrite){if(this.status===TTSStatus.getResult){var n=t;if(n.data&&this.processPCMBase64Data(n.data),0===n.ttsStatus)return void this.end(e,r);var o=e.ttsOption;s={appid:o.appid,extend_params:o.extend_params,cmd:this.status,sid:r.sid,syncid:r.syncid,svc:r.svc},this.getData(s,e,r)}this.status===TTSStatus.sessionEnd&&(this.status=TTSStatus.idle)}else{this.status=TTSStatus.getResult;var a=e.ttsOption,s={appid:a.appid,extend_params:a.extend_params,cmd:this.status,sid:r.sid,syncid:r.syncid,svc:r.svc};this.getData(s,e,r)}else{r.sid=t.sid,this.status=TTSStatus.textWrite;var i=e.ttsOption,s={appid:i.appid,extend_params:i.extend_params,cmd:this.status,sid:r.sid,syncid:r.syncid,svc:r.svc,data:base64_1.encode(e.text)};this.getData(s,e,r)}else this.onError("数据有误");else this.onError()},dc.prototype.getData=function(t,e,r){var n=this;r.syncid=(+r.syncid+1).toString();var o=genRPCMessage(t);return http(e.url,e.apiMethod,JSON.stringify(o)).then(function(t){return n.processResponse(t.result,e,r),console.log(t.result),t.result}).catch(function(t){throw n.onError(t),t})},dc);function dc(t){this.status=TTSStatus.idle,this.processPCMBase64Data=t}var tts=new TTS(processPCMBase64Data),player,wavToMp3Promise,$audio;function base64ToBlob(t){for(var e=base64_1.atob(t),r=e.length,n=new Uint8Array(r);r--;)n[r]=e.charCodeAt(r);return new Blob([n],{type:"wav"})}function processPCMBase64Data(t){t&&Promise.all([t].map(function(t){return pcmToWav(base64ToBlob(t))})).then(function(t){var e=t.map(function(t){return base64ToBlob(t.split(",")[1])});player.appendFiles(e,wavToMp3Promise).then(function(){return $audio.play()})})}var TTSPlay=(Rc.prototype.stop=function(){tts.stop()},Rc.prototype.playAudio=function(t,e){player=new MSEPlayer({onError:console.log}),t.$audio.src=URL.createObjectURL(player.mediaSource),wavToMp3Promise=e,$audio=t.$audio,tts.start(t)},Rc);function Rc(){}return TTSPlay});
//# sourceMappingURL=TTSPlayer.umd.min.js.map
